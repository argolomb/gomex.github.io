<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Testando código puppet</title>

		<meta name="description" content="A presentation on testing your puppet modules.">
		<meta name="author" content="Jan Vansteenkiste">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/sky.css" id="theme">

    <link rel="stylesheet" href="css/custom.css">

		<!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

        <section>
          <h2>Testando código Puppet</h2>
          <h3>Por que?</h3>
          <h3>Como?</h3>
          <h4><a href="http://vstone.eu/talks/puppet-module-testing">Fork dessa apresentação</a></h4>

        </section>


        <section>
          <h3>Quem sou eu</h3>
          <h2>Rafael Gomes</h2>
          <!--<div style="float: left;">
          </div>-->
          <div data-markdown>
          <script type="text/template">
            * `rafael.gomes@ufba.br`   `gomex@raulhc.cc`
            * Tenho um blog:          ...  [http://techfree.com.br](http://techfree.com.br),
            * Github também:           ...  [http://github.com/gomex/](https://github.com/gomex/),
            * E twitter também, sim: ...  [Gomex](https://twitter.com/gomex)
            * IRC                   ...  [irc://irc.freenode.org](irc://irc.freenode.org) nick: Gomex
            * Trabalho:
              * Sysadmin/(Arquiteto)
              * (Para) UFBA [http://wwww.ufba.br](http://www.ufba.br)
              * (Em) Salvador-Bahia
          </script>
        </section>


        <section>
          <h1>A história <br/>do Puppet</h1>
          <h3>(testando)</h3>
        </section>


        <section>
          <h2>No começo</h2>
          <ul>
            <li>Módulos simples:<br/>Install/Config/Service</li>
            <li>Teste?
              <ul class=fragment>
                <li>O que é isso?</li>
                <li>Por que?</li>
              </ul>
            </li>
            <li class="fragment alert">Modificando na produção</li>
          </ul>
        </section>

        <section>
            <h2>Teste de <br/>erros simples</h2>
            <ul style="width: 100%">
              <li class="fragment">Sintaxe<span class="fragment">: Pegar erros</br>Antes de aplicar a regra</span>
                <pre class="fragment"><code>puppet parser validate &lt;filename&gt;</code></pre>
              </li>
              <li class="fragment">Estilo<span class="fragment">: Pegar más práticas de design</span>
                <ul class="fragment">
                  <li>Comportamento inesperado
                    <ul>
                      <li>Boleano com aspas</li>
                      <li>'$strings' em comandos</li>
                    </ul>
                  </li>
                  <li>Código mais fácil de depurar: Especialmente para outra pessoa analisar.</li>
                </ul>
                <pre class="fragment"><code>puppet-lint &lt;filename&gt;</code></pre>
              </li>
            </ul>
        </section>

        <section>
          <h2>Começa o crescimento</h2>
          <h3 class=fragment>(adicionado complexidade)</h3>
          <ul class=fragment>
            <li>Configuração tem parâmetros</li>
            <li>Lidando com diferentes distribuições</li>
            <li class="fragment fade-in">
              <span class="alert">Modificando na produção</span>
              <span id="xxx" class="fragment replace"><br/>Kitchen</span>
            </li>
          </ul>
        </section>

        <section data-state="kitchen">
          <h2>Kitchen</h2>
          <a style="color: black;" href="http://kitchen.ci/">http://kitchen.ci/</a>
          <br/>
          <ul class="fragment">
            <li>Teste local</li>
            <li>Garantia de ambiente exato</li>
            <li>kitchen converge, verify, destroy, test</li>
            <li>Interação com host</li>
          </ul>
        </section>

        <section>
          <h2>Ambiente com docker</h2>
          <h3>Preparando o ambiente</h3>
          <h3>Debian Jessie</h3>
          <pre><code contenteditable class="bash">
# git clone git@git.ufba.br:cri/automacao.git
# cd automacao
# aptitude install bundler
# curl -sSL https://get.docker.com/ | sh
# usermod -aG docker seu_usuario
# bundle install
</code></pre>
          <h4>Links</h4>
          <ul>
            <li><a href="https://github.com/portertech/kitchen-docker">Documentação</a></li>
          </ul>
        </section>

        <section>
          <h2>Ambiente com vagrant</h2>
          <h3>Preparando o ambiente</h3>
          <h3>Debian Jessie</h3>
          <pre><code contenteditable class="bash">
# aptitude install bundler vagrant virtualbox
# bundle install
# cp .kitchen.yml.vagrant .kitchen.yml
</code></pre>
          <h4>Links</h4>
          <ul>
            <li><a href="https://github.com/test-kitchen/kitchen-vagrant">Documentação</a></li>
          </ul>
        </section>

        <section>
          <h3>kitchen.yml</h3>
          <pre><code contenteditable class="ruby">
---
driver:
  name: docker

provisioner:
  name: puppet_apply
  manifests_path: manifests
  modules_path: modules
  manifest: site.pp
  puppet_debug: false
  puppet_verbose: false

platforms:
  - name: debian-8
    driver_config:
       image: debian:8
  - name: debian-7
    driver_config:
       image: debian:7


suites:
  - name: padrao
    provisioner:
      manifest: site.pp
</code></pre>
          <h4>Links</h4>
          <ul>
            <li><a href="http://kitchen.ci/docs/getting-started/">Começando</a></li>
            <li><a href="http://ehaselwanter.com/en/blog/2014/05/08/using-test-kitchen-with-puppet/">Kitchen para puppet</a></li>
            <li><a href="https://github.com/portertech/kitchen-docker">Kitchen com docker</a></li>
          </ul>
        </section>

        <section>
          <h3>kitchen.yml.vagrant</h3>
          <pre><code contenteditable class="ruby">
---
driver:
  name: vagrant

provisioner:
  name: puppet_apply
  manifests_path: manifests
  modules_path: modules
  manifest: site.pp
  puppet_debug: true
  puppet_verbose: true

platforms:
  - name: Debian-8.0-64-bit
    driver_plugin: vagrant
    driver_config:
      box: Debian-8.0-64-bit
      box_url: http://static.gender-api.com/debian-8-jessie-rc2-x64-slim.box
  - name: Debian-7.8.0-64-bit
    driver_plugin: vagrant
    driver_config:
      box: debian-7.8.0-64-bit
      box_url:  https://downloads.sourceforge.net/project/vagrantdebianboxes/debianwheezy.box?r=&ts=1374688209&use_mirror=heanet

suites:
  - name: padrao
    provisioner:
      manifest: site.pp
</code></pre>
          <h4>Links</h4>
          <ul>
            <li><a href="http://kitchen.ci/docs/getting-started/">Começando</a></li>
            <li><a href="http://ehaselwanter.com/en/blog/2014/05/08/using-test-kitchen-with-puppet/">Kitchen para puppet</a></li>
            <li><a href="https://github.com/test-kitchen/kitchen-vagrant">Kitchen com vagrant</a></li>
          </ul>
        </section>
        <section data-state="bats">
          <h2><a style="color: black;" href="https://github.com/sstephenson/bats">Bats</a></h2>
          <br/>
          <ul class="fragment">
            <li>Framework de teste</li>
            <li>Teste de aceitação/integração</li>
            <li>Bash Sysadmin</li>
            <li>Interação com host</li>
          </ul>
          <h4>Links</h4>
          <ul>
            <li><a href="https://github.com/sstephenson/bats/wiki/Syntax-Highlighting">Sintaxe no vim</a></li>
          </ul>
        </section>
        <section>
          <h2>Criando testes</h2>
          <h3>RUN</h3>          
          <pre><code contenteditable class="ruby">
@test "invoking foo with a nonexistent file prints an error" {
  run foo nonexistent_filename
  [ "$status" -eq 1 ]
  [ "$output" = "foo: no such file 'nonexistent_filename'" ]
}
</code></pre>
          <br/>
          <pre><code contenteditable class="ruby">
@test "invoking foo without arguments prints usage" {
  run foo
  [ "$status" -eq 1 ]
  [ "${lines[0]}" = "usage: foo <filename>" ]
}
</code></pre>

          <h4>Links</h4>
          <ul>
            <li><a href="https://github.com/sstephenson/bats">Documentação</a></li>
          </ul>
        </section>
        <section>
          <h2>Criando testes</h2>
          <h3>LOAD</h3>                     
          <pre><code contenteditable class="ruby">
load test_helper
</code></pre>
          <br/>
          <h3>SKIP</h3>                    
          <pre><code contenteditable class="ruby">
@test "A test I don't want to execute for now" {
  skip "This command will return zero soon, but not now"
  run foo
  [ "$status" -eq 0 ]
}
</code></pre>
          <pre><code contenteditable class="ruby">
@test "A test which should run" {
  if [ foo != bar ]; then
    skip "foo isn't bar"
  fi

  run foo
  [ "$status" -eq 0 ]
}
</code></pre>
        </section>
        <section>
          <h2>Criando testes</h2>
          <h3>SETUP</h3>                    
          <pre><code contenteditable class="ruby">
setup() {
  VARIAVEL="STRING"
  REPO=True
  mkdir /tmp/teste
}
</code></pre>
          <br/>
          <h3>TEARDOWN</h3> 
          <pre><code contenteditable class="ruby">
teardown() {
  unset VARIAVEL
  unset REPO
     rm -fr /tmp/teste
   }
   </code></pre>
           </section>

           <section>
               <h2>Organização dos testes</h2>
               <h3>Uma suite por tecnologia</h3>
               <ul style="width: 100%">
                 <li>Padrão GNU/Linux</li>
                 <li>JBoss</li>
                 <li>Tomcat</li>
                 <li>Apache</li>
                 <li>Mysql</li>
                 <li>...</li>
               </ul>
           </section>
           <section>
               <h2>Organização das pastas</h2>
               <pre><code contenteditable class="ruby">
tree test/
test/
└── integration
    ├── jboss
    ├── mysql
    ├── padrao
    │   └── bats
    │       ├── apt-repo.bats
    │       └── ntp.bats
    └── tomcat
               </code></pre>

          </section>
          <section>
            <h2>Exemplo</h2>
            <h3>Padrão - NTP</h3>
               <pre><code contenteditable class="ruby">
@test '#NTP ntp is up and running' {
  pgrep ntp
}

@test '#NTP ntp.conf contains correct servers' {
  run grep "server ntp.ufba.br iburst" /etc/ntp.conf
  [ "$status" -eq 0 ]
}
               </code></pre>
          </section>
          <section>
            <h2>Executando</h2>
               <pre><code contenteditable class="bash">
# git clone git@git.ufba.br:cri/automacao.git
# cd automacao
# kitchen converge
# kitchen verify
               </code></pre>
          </section>          
          <section>
            <h2>Retorno</h2>
               <pre><code class="ruby">
-----> Setting up padrao-debian-7...
...
 ✓ #APT-REPO sources.list contains correct servers
 ✓ #NTP ntp is up and running
 ✓ #NTP ntp.conf contains correct servers
               </code></pre>
               <pre><code class="ruby">
-----> Setting up padrao-debian-8...
...
 ✓ #APT-REPO sources.list contains correct servers
 ✓ #NTP ntp is up and running
 ✓ #NTP ntp.conf contains correct servers
               </code></pre>
          </section>
          <section>
            <h2>Próximos desafios</h2>
            <ul>
              <li>Automatizar workflow de teste</li>
              <li>Integração com hiera</li>
            </ul>
          </section>
          <section>
            <h1>Dúvidas?</h1>
            <ul>
              <li>rafael.gomes@ufba.br</li>
              <li>Twitter: Gomex</li>
              <li>IRC: gomex</li>
              <li><a href="http://gomex.github.io/apresentacao-teste-codigo-puppet">Essa apresentação</a>
              <li><a href="http://techfree.com.br">http://techfree.com.br</a></li>
            </ul>
          </section>
      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>
    <script src="js/jquery-1.9.0.js"></script>
    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        autoSlide: 0,
        mouseWheel: false,


        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
        { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
        { src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/highlight/highlight.js', async: true, callback: function() {
            hljs.tabReplace = '  ';
            hljs.initHighlightingOnLoad();
          }
        },
        { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
        { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>
    <style type="text/css"><!--
      pre>code {
        z-index: 1000 !important;
      }
    --></style>

    <script type="text/javascript"><!--

      function hasClass(element, cls) {
        return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
      }

      Reveal.addEventListener( 'slidechanged', function( event ) {
          $('pre code').css({position: 'relative'});
      });

      Reveal.addEventListener('fragmentshown', function (event) {
          $('pre code').css({position: 'relative'});
          fragment = event.fragment;
          if (hasClass(fragment,'replace')) {
            fragment.previousElementSibling.style.textDecoration = 'line-through';
          }
      } );

      $('pre code').click(function(evt) {
        if (evt.ctrlKey) {
        $(this).css({ position: 'absolute', left: '50%'});
        var w = $(this).outerWidth()
        var offset = (w / 2);
        $(this).css({ marginLeft: '-' + offset + 'px' });
        }
      });

     --></script>

  </body>
</html>
